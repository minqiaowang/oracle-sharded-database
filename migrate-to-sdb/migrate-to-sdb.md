# Migrate Application to Sharded Dataabase

## Introduction

In this lab, you will migrate the demo application from the non-shard database to the sharded database. You need re-design the schema, migrate the data and modify the applications.

Estimated Lab Time: 20 minutes.

### Objectives

In this lab, you will perform the following steps:

- Re-Design and create the demo Schema.
- Verify the shard demo schema

- Migrate data to the sharded database.
- Setup and Run the demo applications



### Prerequisites

This lab assumes you have already completed the following:

- Sharded database deployment.
- Setup a non-shard database.



## **Step 1:** Re-Design and Create the Demo Schema

Before the existing database can be migrated to the sharded database, you must decide how to organize the sharded database. You must decide which tables in the application are sharded and which tables are duplicated tables. In this lab, we have already created a scripts for the sharded demo schema. It's create a sharded table family: `Customers-->Orders-->LineItems`, and the `Products` is the duplicated table.

1. Login to the catalog database host, switch to oracle user.

   ```
   $ ssh -i labkey opc@152.67.196.50
   Last login: Sun Nov 29 01:26:28 2020 from 59.66.120.23
   -bash: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8): No such file or directory
   
   [opc@cata ~]$ sudo su - oracle
   Last login: Sun Nov 29 02:49:51 GMT 2020 on pts/0
    
   [oracle@cata ~]$ 
   ```

   

2. Download the sharded demo schema SQL scripts `sdb-app-schema.sql`.

   ```
   [oracle@cata ~]$ <copy></copy>
   ```

   

3. Review the content in the sql scripts file.

   ```
   [oracle@cata ~]$ <copy>cat sdb-app-schema.sql</copy> 
   set echo on 
   set termout on
   set time on
   spool /home/oracle/sdb_app_schema.lst
   REM
   REM Connect to the Shard Catalog and Create Schema
   REM
   connect / as sysdba
   alter session set container=catapdb;
   alter session enable shard ddl;
   create user app_schema identified by app_schema;
   grant connect, resource, alter session to app_schema;
   grant execute on dbms_crypto to app_schema;
   grant create table, create procedure, create tablespace, create materialized view to app_schema;
   grant unlimited tablespace to app_schema;
   grant select_catalog_role to app_schema;
   grant all privileges to app_schema;
   grant gsmadmin_role to app_schema;
   grant dba to app_schema;
   
   
   REM
   REM Create a tablespace set for SHARDED tables
   REM
   CREATE TABLESPACE SET  TSP_SET_1 using template (datafile size 100m autoextend on next 10M maxsize unlimited extent management  local segment space management auto );
   
   REM
   REM Create a tablespace for DUPLICATED tables
   REM
   CREATE TABLESPACE products_tsp datafile size 100m autoextend on next 10M maxsize unlimited extent management local uniform size 1m; 
    
   REM
   REM Create Sharded and Duplicated tables
   REM
   connect app_schema/app_schema@catapdb
   alter session enable shard ddl;
   REM
   REM Create a Sharded table for Customers  (Root table)
   REM
   CREATE SHARDED TABLE Customers
   (
     CustId      VARCHAR2(60) NOT NULL,
     FirstName   VARCHAR2(60),
     LastName    VARCHAR2(60),
     Class       VARCHAR2(10),
     Geo         VARCHAR2(8),
     CustProfile VARCHAR2(4000),
     Passwd      RAW(60),
     CONSTRAINT pk_customers PRIMARY KEY (CustId),
     CONSTRAINT json_customers CHECK (CustProfile IS JSON)
   ) TABLESPACE SET TSP_SET_1
   PARTITION BY CONSISTENT HASH (CustId) PARTITIONS AUTO;
   
   REM
   REM Create a Sharded table for Orders
   REM
   CREATE SHARDED TABLE Orders
   (
     OrderId     INTEGER NOT NULL,
     CustId      VARCHAR2(60) NOT NULL,
     OrderDate   TIMESTAMP NOT NULL,
     SumTotal    NUMBER(19,4),
     Status      CHAR(4),
     constraint  pk_orders primary key (CustId, OrderId),
     constraint  fk_orders_parent foreign key (CustId) 
       references Customers on delete cascade
   ) partition by reference (fk_orders_parent);
   
   REM
   REM Create the sequence used for the OrderId column
   REM
   CREATE SEQUENCE Orders_Seq;
   
   REM
   REM Create a Sharded table for LineItems
   REM
   CREATE SHARDED TABLE LineItems
   (
     OrderId     INTEGER NOT NULL,
     CustId      VARCHAR2(60) NOT NULL,
     ProductId   INTEGER NOT NULL,
     Price       NUMBER(19,4),
     Qty         NUMBER,
     constraint  pk_items primary key (CustId, OrderId, ProductId),
     constraint  fk_items_parent foreign key (CustId, OrderId)
       references Orders on delete cascade
   ) partition by reference (fk_items_parent);
   
   REM
   REM Create Duplicated table for Products
   REM
   CREATE DUPLICATED TABLE Products
   (
     ProductId  INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
     Name       VARCHAR2(128),
     DescrUri   VARCHAR2(128),
     LastPrice  NUMBER(19,4)
   ) TABLESPACE products_tsp;
   
   REM
   REM Create functions for Password creation and checking â€“ used by the REM demo loader application
   REM
   
   CREATE OR REPLACE FUNCTION PasswCreate(PASSW IN RAW)
     RETURN RAW
   IS
     Salt RAW(8);
   BEGIN
     Salt := DBMS_CRYPTO.RANDOMBYTES(8);
     RETURN UTL_RAW.CONCAT(Salt, DBMS_CRYPTO.HASH(UTL_RAW.CONCAT(Salt, PASSW), DBMS_CRYPTO.HASH_SH256));
   END;
   /
   
   CREATE OR REPLACE FUNCTION PasswCheck(PASSW IN RAW, PHASH IN RAW)
     RETURN INTEGER IS
   BEGIN
     RETURN UTL_RAW.COMPARE(
         DBMS_CRYPTO.HASH(UTL_RAW.CONCAT(UTL_RAW.SUBSTR(PHASH, 1, 8), PASSW), DBMS_CRYPTO.HASH_SH256),
         UTL_RAW.SUBSTR(PHASH, 9));
   END;
   /
   
   REM
   REM
   select table_name from user_tables;
   REM
   REM
   spool off
   ```

   

4. Use SQLPLUS to run this sql scripts

   ```
   [oracle@cata ~]$ sqlplus /nolog
   
   SQL*Plus: Release 19.0.0.0.0 - Production on Mon Nov 30 01:26:03 2020
   Version 19.7.0.0.0
   
   Copyright (c) 1982, 2020, Oracle.  All rights reserved.
   
   
   SQL> @sdb-app-schema.sql
   ```

   

5. The result screen like the following. 

   ```
   SQL> set termout on
   SQL> set time on
   01:26:37 SQL> spool /home/oracle/sdb_app_schema.lst
   01:26:37 SQL> REM
   01:26:37 SQL> REM Connect to the Shard Catalog and Create Schema
   01:26:37 SQL> REM
   01:26:37 SQL> connect / as sysdba
   Connected.
   01:26:37 SQL> alter session set container=catapdb;
   
   Session altered.
   
   01:26:37 SQL> alter session enable shard ddl;
   
   Session altered.
   
   01:26:37 SQL> create user app_schema identified by app_schema;
   
   User created.
   
   01:26:37 SQL> grant connect, resource, alter session to app_schema;
   
   Grant succeeded.
   
   01:26:37 SQL> grant execute on dbms_crypto to app_schema;
   
   Grant succeeded.
   
   01:26:37 SQL> grant create table, create procedure, create tablespace, create materialized view to app_schema;
   
   Grant succeeded.
   
   01:26:37 SQL> grant unlimited tablespace to app_schema;
   
   Grant succeeded.
   
   01:26:37 SQL> grant select_catalog_role to app_schema;
   
   Grant succeeded.
   
   01:26:37 SQL> grant all privileges to app_schema;
   
   Grant succeeded.
   
   01:26:37 SQL> grant gsmadmin_role to app_schema;
   
   Grant succeeded.
   
   01:26:37 SQL> grant dba to app_schema;
   
   Grant succeeded.
   
   01:26:37 SQL> 
   01:26:37 SQL> 
   01:26:37 SQL> REM
   01:26:37 SQL> REM Create a tablespace set for SHARDED tables
   01:26:37 SQL> REM
   01:26:37 SQL> CREATE TABLESPACE SET  TSP_SET_1 using template (datafile size 100m autoextend on next 10M maxsize unlimited extent management	local segment space management auto );
   
   Tablespace created.
   
   01:26:39 SQL> 
   01:26:39 SQL> REM
   01:26:39 SQL> REM Create a tablespace for DUPLICATED tables
   01:26:39 SQL> REM
   01:26:39 SQL> CREATE TABLESPACE products_tsp datafile size 100m autoextend on next 10M maxsize unlimited extent management local uniform size 1m;
   
   Tablespace created.
   
   01:26:40 SQL> 
   01:26:40 SQL> REM
   01:26:40 SQL> REM Create Sharded and Duplicated tables
   01:26:40 SQL> REM
   01:26:40 SQL> connect app_schema/app_schema@catapdb
   Connected.
   01:26:40 SQL> alter session enable shard ddl;
   
   Session altered.
   
   01:26:40 SQL> REM
   01:26:40 SQL> REM Create a Sharded table for Customers	(Root table)
   01:26:40 SQL> REM
   01:26:40 SQL> CREATE SHARDED TABLE Customers
   01:26:40   2  (
   01:26:40   3  	CustId	    VARCHAR2(60) NOT NULL,
   01:26:40   4  	FirstName   VARCHAR2(60),
   01:26:40   5  	LastName    VARCHAR2(60),
   01:26:40   6  	Class	    VARCHAR2(10),
   01:26:40   7  	Geo	    VARCHAR2(8),
   01:26:40   8  	CustProfile VARCHAR2(4000),
   01:26:40   9  	Passwd	    RAW(60),
   01:26:40  10  	CONSTRAINT pk_customers PRIMARY KEY (CustId),
   01:26:40  11  	CONSTRAINT json_customers CHECK (CustProfile IS JSON)
   01:26:40  12  ) TABLESPACE SET TSP_SET_1
   01:26:40  13  PARTITION BY CONSISTENT HASH (CustId) PARTITIONS AUTO;
   
   Table created.
   
   01:26:41 SQL> 
   01:26:41 SQL> REM
   01:26:41 SQL> REM Create a Sharded table for Orders
   01:26:41 SQL> REM
   01:26:41 SQL> CREATE SHARDED TABLE Orders
   01:26:41   2  (
   01:26:41   3  	OrderId     INTEGER NOT NULL,
   01:26:41   4  	CustId	    VARCHAR2(60) NOT NULL,
   01:26:41   5  	OrderDate   TIMESTAMP NOT NULL,
   01:26:41   6  	SumTotal    NUMBER(19,4),
   01:26:41   7  	Status	    CHAR(4),
   01:26:41   8  	constraint  pk_orders primary key (CustId, OrderId),
   01:26:41   9  	constraint  fk_orders_parent foreign key (CustId)
   01:26:41  10  	  references Customers on delete cascade
   01:26:41  11  ) partition by reference (fk_orders_parent);
   
   Table created.
   
   01:26:41 SQL> 
   01:26:41 SQL> REM
   01:26:41 SQL> REM Create the sequence used for the OrderId column
   01:26:41 SQL> REM
   01:26:41 SQL> CREATE SEQUENCE Orders_Seq;
   
   Sequence created.
   
   01:26:41 SQL> 
   01:26:41 SQL> REM
   01:26:41 SQL> REM Create a Sharded table for LineItems
   01:26:41 SQL> REM
   01:26:41 SQL> CREATE SHARDED TABLE LineItems
   01:26:41   2  (
   01:26:41   3  	OrderId     INTEGER NOT NULL,
   01:26:41   4  	CustId	    VARCHAR2(60) NOT NULL,
   01:26:41   5  	ProductId   INTEGER NOT NULL,
   01:26:41   6  	Price	    NUMBER(19,4),
   01:26:41   7  	Qty	    NUMBER,
   01:26:41   8  	constraint  pk_items primary key (CustId, OrderId, ProductId),
   01:26:41   9  	constraint  fk_items_parent foreign key (CustId, OrderId)
   01:26:41  10  	  references Orders on delete cascade
   01:26:41  11  ) partition by reference (fk_items_parent);
   
   Table created.
   
   01:26:41 SQL> 
   01:26:41 SQL> REM
   01:26:41 SQL> REM Create Duplicated table for Products
   01:26:41 SQL> REM
   01:26:41 SQL> CREATE DUPLICATED TABLE Products
   01:26:41   2  (
   01:26:41   3  	ProductId  INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
   01:26:41   4  	Name	   VARCHAR2(128),
   01:26:41   5  	DescrUri   VARCHAR2(128),
   01:26:41   6  	LastPrice  NUMBER(19,4)
   01:26:41   7  ) TABLESPACE products_tsp;
   
   Table created.
   
   01:26:41 SQL> 
   01:26:41 SQL> REM
   01:26:41 SQL> REM Create functions for Password creation and checking â€“ used by the REM demo loader application
   01:26:41 SQL> REM
   01:26:41 SQL> 
   01:26:41 SQL> CREATE OR REPLACE FUNCTION PasswCreate(PASSW IN RAW)
   01:26:41   2  	RETURN RAW
   01:26:41   3  IS
   01:26:41   4  	Salt RAW(8);
   01:26:41   5  BEGIN
   01:26:41   6  	Salt := DBMS_CRYPTO.RANDOMBYTES(8);
   01:26:41   7  	RETURN UTL_RAW.CONCAT(Salt, DBMS_CRYPTO.HASH(UTL_RAW.CONCAT(Salt, PASSW), DBMS_CRYPTO.HASH_SH256));
   01:26:41   8  END;
   01:26:41   9  /
   
   Function created.
   
   01:26:41 SQL> 
   01:26:41 SQL> CREATE OR REPLACE FUNCTION PasswCheck(PASSW IN RAW, PHASH IN RAW)
   01:26:41   2  	RETURN INTEGER IS
   01:26:41   3  BEGIN
   01:26:41   4  	RETURN UTL_RAW.COMPARE(
   01:26:41   5  	    DBMS_CRYPTO.HASH(UTL_RAW.CONCAT(UTL_RAW.SUBSTR(PHASH, 1, 8), PASSW), DBMS_CRYPTO.HASH_SH256),
   01:26:41   6  	    UTL_RAW.SUBSTR(PHASH, 9));
   01:26:41   7  END;
   01:26:41   8  /
   
   Function created.
   
   01:26:41 SQL> 
   01:26:41 SQL> REM
   01:26:41 SQL> REM
   01:26:41 SQL> select table_name from user_tables;
   
   TABLE_NAME
   --------------------------------------------------------------------------------
   CUSTOMERS
   ORDERS
   LINEITEMS
   PRODUCTS
   MLOG$_PRODUCTS
   RUPD$_PRODUCTS
   
   6 rows selected.
   
   01:26:41 SQL> REM
   01:26:41 SQL> REM
   01:26:41 SQL> spool off
   01:26:41 SQL> 
   ```

   

6. The shard app demo schema is created. Exit the sqlplus.

   ```
   01:26:41 SQL> exit
   Disconnected from Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
   Version 19.7.0.0.0
   [oracle@cata ~]$
   ```

   

## **Step 2:** Verify the Sharded Demo Schema

Now, we can verify the sharded demo schema which created in the previous step. 

1. Switch to the GSM environment, run GDSCTL.

   ```
   [oracle@cata ~]$ . ./gsm.sh 
   
   [oracle@cata ~]$ 
   ```
   
   
   
2. Check the shard director listener status. You can see a service named `oltp_rw_srvc.orasdb.oradbcloud` and a service named `GDS$CATALOG.oradbcloud` listening on 1522 port.

   ```
   [oracle@cata ~]$ <copy>lsnrctl status SHARDDIRECTOR1</copy>
   
   LSNRCTL for Linux: Version 19.0.0.0.0 - Production on 30-NOV-2020 03:34:25
   
   Copyright (c) 1991, 2019, Oracle.  All rights reserved.
   
   Connecting to (DESCRIPTION=(ADDRESS=(HOST=cata)(PORT=1522)(PROTOCOL=tcp))(CONNECT_DATA=(SERVICE_NAME=GDS$CATALOG.oradbcloud)))
   STATUS of the LISTENER
   ------------------------
   Alias                     SHARDDIRECTOR1
   Version                   TNSLSNR for Linux: Version 19.0.0.0.0 - Production
   Start Date                29-NOV-2020 04:26:16
   Uptime                    0 days 23 hr. 8 min. 8 sec
   Trace Level               off
   Security                  ON: Local OS Authentication
   SNMP                      OFF
   Listener Parameter File   /u01/app/oracle/product/19c/gsmhome_1/network/admin/gsm.ora
   Listener Log File         /u01/app/oracle/diag/gsm/cata/sharddirector1/alert/log.xml
   Listening Endpoints Summary...
     (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=cata)(PORT=1522)))
   Services Summary...
   Service "GDS$CATALOG.oradbcloud" has 1 instance(s).
     Instance "cata", status READY, has 1 handler(s) for this service...
   Service "GDS$COORDINATOR.oradbcloud" has 1 instance(s).
     Instance "cata", status READY, has 1 handler(s) for this service...
   Service "_MONITOR" has 1 instance(s).
     Instance "SHARDDIRECTOR1", status READY, has 1 handler(s) for this service...
   Service "_PINGER" has 1 instance(s).
     Instance "SHARDDIRECTOR1", status READY, has 1 handler(s) for this service...
   Service "oltp_rw_srvc.orasdb.oradbcloud" has 2 instance(s).
     Instance "orasdb%1", status READY, has 1 handler(s) for this service...
     Instance "orasdb%11", status READY, has 1 handler(s) for this service...
   The command completed successfully
   [oracle@cata ~]$ 
   ```

   

3. Launch GDSCTL.

   ```
   [oracle@cata ~]$ gdsctl
   GDSCTL: Version 19.0.0.0.0 - Production on Mon Nov 30 01:41:47 GMT 2020
   
   Copyright (c) 2011, 2019, Oracle.  All rights reserved.
   
   Welcome to GDSCTL, type "help" for information.
   
   Current GSM is set to SHARDDIRECTOR1
   GDSCTL> 
   ```

   

4. Run the following commands to observe that there are no failures during the creation of tablespaces.

   ```
   GDSCTL> show ddl
   Catalog connection is established
   id      DDL Text                                 Failed shards 
   --      --------                                 ------------- 
   9       grant dba to app_schema                                
   10      CREATE TABLESPACE SET  TSP_SET_1 usin...               
   11      CREATE TABLESPACE products_tsp datafi...               
   12      CREATE SHARDED TABLE Customers (   Cu...               
   13      CREATE SHARDED TABLE Orders (   Order...               
   14      CREATE SEQUENCE Orders_Seq                             
   15      CREATE SHARDED TABLE LineItems (   Or...               
   16      CREATE MATERIALIZED VIEW "APP_SCHEMA"...               
   17      CREATE OR REPLACE FUNCTION PasswCreat...               
   18      CREATE OR REPLACE FUNCTION PasswCheck...               
   
   GDSCTL> 
   ```

   

5. Run the config commands as shown below for each of the shards and verify if there are any DDL error.

   ```
   GDSCTL> config shard -shard shd1_shdpdb1
   Name: shd1_shdpdb1
   Shard Group: shardgroup_primary
   Status: Ok
   State: Deployed
   Region: region1
   Connection string: shd1:1521/shdpdb1
   SCAN address: 
   ONS remote port: 0
   Disk Threshold, ms: 20
   CPU Threshold, %: 75
   Version: 19.0.0.0
   Failed DDL: 
   DDL Error: ---
   Failed DDL id: 
   Availability: ONLINE
   Rack: 
   
   
   Supported services
   ------------------------
   Name                                                            Preferred Status    
   ----                                                            --------- ------    
   oltp_rw_srvc                                                    Yes       Enabled   
   
   GDSCTL> config shard -shard shd2_shdpdb2
   Name: shd2_shdpdb2
   Shard Group: shardgroup_primary
   Status: Ok
   State: Deployed
   Region: region1
   Connection string: shd2:1521/shdpdb2
   SCAN address: 
   ONS remote port: 0
   Disk Threshold, ms: 20
   CPU Threshold, %: 75
   Version: 19.0.0.0
   Failed DDL: 
   DDL Error: ---
   Failed DDL id: 
   Availability: ONLINE
   Rack: 
   
   
   Supported services
   ------------------------
   Name                                                            Preferred Status    
   ----                                                            --------- ------    
   oltp_rw_srvc                                                    Yes       Enabled   
   
   GDSCTL> 
   ```

   

6. Show the created chunks.

   ```
   GDSCTL> config chunks
   Chunks
   ------------------------
   Database                      From      To        
   --------                      ----      --        
   shd1_shdpdb1                  1         6         
   shd2_shdpdb2                  7         12        
   
   GDSCTL> 
   ```

   

7. Exit GDSCTL.

   ```
   GDSCTL> exit
   [oracle@cata ~]$ 
   ```

   

8. Connect to the shard pdb1.

   ```
   [oracle@cata ~]$ <copy>sqlplus sys/Ora_DB4U@shd1:1521/shdpdb1 as sysdba</copy>
   
   SQL*Plus: Release 19.0.0.0.0 - Production on Mon Nov 30 02:01:17 2020
   Version 19.3.0.0.0
   
   Copyright (c) 1982, 2019, Oracle.  All rights reserved.
   
   
   Connected to:
   Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
   Version 19.7.0.0.0
   
   SQL> 
   ```

   

9. Check the created tablespace set.

   ```
   SQL> <copy>select TABLESPACE_NAME, BYTES/1024/1024 MB from sys.dba_data_files order by tablespace_name;</copy>
   
   TABLESPACE_NAME 		       MB
   ------------------------------ ----------
   C001TSP_SET_1			      100
   C002TSP_SET_1			      100
   C003TSP_SET_1			      100
   C004TSP_SET_1			      100
   C005TSP_SET_1			      100
   C006TSP_SET_1			      100
   PRODUCTS_TSP			      100
   SYSAUX				      420
   SYSTEM				      310
   TSP_SET_1			      100
   UNDOTBS1			      165
   
   TABLESPACE_NAME 		       MB
   ------------------------------ ----------
   USERS					5
   
   12 rows selected.
   
   SQL> 
   ```

   

10. Verify that the chunks and chunk tablespaces are created.

   ```
   SQL> set linesize 140
   SQL> column table_name format a20
   SQL> column tablespace_name format a20
   SQL> column partition_name format a20
   SQL> select table_name, partition_name, tablespace_name from dba_tab_partitions where tablespace_name like 'C%TSP_SET_1' order by tablespace_name;
   
   TABLE_NAME	     PARTITION_NAME	  TABLESPACE_NAME
   -------------------- -------------------- --------------------
   ORDERS		     CUSTOMERS_P1	  C001TSP_SET_1
   CUSTOMERS	     CUSTOMERS_P1	  C001TSP_SET_1
   LINEITEMS	     CUSTOMERS_P1	  C001TSP_SET_1
   CUSTOMERS	     CUSTOMERS_P2	  C002TSP_SET_1
   LINEITEMS	     CUSTOMERS_P2	  C002TSP_SET_1
   ORDERS		     CUSTOMERS_P2	  C002TSP_SET_1
   CUSTOMERS	     CUSTOMERS_P3	  C003TSP_SET_1
   ORDERS		     CUSTOMERS_P3	  C003TSP_SET_1
   LINEITEMS	     CUSTOMERS_P3	  C003TSP_SET_1
   ORDERS		     CUSTOMERS_P4	  C004TSP_SET_1
   CUSTOMERS	     CUSTOMERS_P4	  C004TSP_SET_1
   
   TABLE_NAME	     PARTITION_NAME	  TABLESPACE_NAME
   -------------------- -------------------- --------------------
   LINEITEMS	     CUSTOMERS_P4	  C004TSP_SET_1
   CUSTOMERS	     CUSTOMERS_P5	  C005TSP_SET_1
   LINEITEMS	     CUSTOMERS_P5	  C005TSP_SET_1
   ORDERS		     CUSTOMERS_P5	  C005TSP_SET_1
   CUSTOMERS	     CUSTOMERS_P6	  C006TSP_SET_1
   LINEITEMS	     CUSTOMERS_P6	  C006TSP_SET_1
   ORDERS		     CUSTOMERS_P6	  C006TSP_SET_1
   
   18 rows selected.
   
   SQL> 
   ```

   

11. Connect to the shard pdb2.

    ```
    SQL> <copy>connect sys/Ora_DB4U@shd2:1521/shdpdb2 as sysdba</copy>
    Connected.
    SQL>
    ```

    

12. Check the created tablespace set.

    ```
    SQL> <copy>select TABLESPACE_NAME, BYTES/1024/1024 MB from sys.dba_data_files order by tablespace_name;</copy>
    
    TABLESPACE_NAME 		       MB
    ------------------------------ ----------
    C007TSP_SET_1			      100
    C008TSP_SET_1			      100
    C009TSP_SET_1			      100
    C00ATSP_SET_1			      100
    C00BTSP_SET_1			      100
    C00CTSP_SET_1			      100
    PRODUCTS_TSP			      100
    SYSAUX				      440
    SYSTEM				      310
    TSP_SET_1			      100
    UNDOTBS1			      165
    
    TABLESPACE_NAME 		       MB
    ------------------------------ ----------
    USERS					5
    
    12 rows selected.
    
    SQL> 
    ```

    

13. Verify that the chunks and chunk tablespaces are created.

    ```
    SQL> set linesize 140
    SQL> column table_name format a20
    SQL> column tablespace_name format a20
    SQL> column partition_name format a20
    SQL> select table_name, partition_name, tablespace_name from dba_tab_partitions where tablespace_name like 'C%TSP_SET_1' order by tablespace_name;
    
    TABLE_NAME	     PARTITION_NAME	  TABLESPACE_NAME
    -------------------- -------------------- --------------------
    ORDERS		     CUSTOMERS_P7	  C007TSP_SET_1
    CUSTOMERS	     CUSTOMERS_P7	  C007TSP_SET_1
    LINEITEMS	     CUSTOMERS_P7	  C007TSP_SET_1
    CUSTOMERS	     CUSTOMERS_P8	  C008TSP_SET_1
    LINEITEMS	     CUSTOMERS_P8	  C008TSP_SET_1
    ORDERS		     CUSTOMERS_P8	  C008TSP_SET_1
    CUSTOMERS	     CUSTOMERS_P9	  C009TSP_SET_1
    ORDERS		     CUSTOMERS_P9	  C009TSP_SET_1
    LINEITEMS	     CUSTOMERS_P9	  C009TSP_SET_1
    ORDERS		     CUSTOMERS_P10	  C00ATSP_SET_1
    CUSTOMERS	     CUSTOMERS_P10	  C00ATSP_SET_1
    
    TABLE_NAME	     PARTITION_NAME	  TABLESPACE_NAME
    -------------------- -------------------- --------------------
    LINEITEMS	     CUSTOMERS_P10	  C00ATSP_SET_1
    CUSTOMERS	     CUSTOMERS_P11	  C00BTSP_SET_1
    LINEITEMS	     CUSTOMERS_P11	  C00BTSP_SET_1
    ORDERS		     CUSTOMERS_P11	  C00BTSP_SET_1
    CUSTOMERS	     CUSTOMERS_P12	  C00CTSP_SET_1
    LINEITEMS	     CUSTOMERS_P12	  C00CTSP_SET_1
    ORDERS		     CUSTOMERS_P12	  C00CTSP_SET_1
    
    18 rows selected.
    
    SQL> 
    ```

    

14. Connect to the shardcatalog.

    ```
    SQL> <copy>connect sys/Ora_DB4U@cata:1521/catapdb as sysdba</copy>
    Connected.
    SQL> 
    ```

    

15. Query the `gsmadmin_internal.chunk_loc` table to observe that the chunks are uniformly distributed.

    ```
    SQL> column shard format a40
    SQL> select a.name Shard,count( b.chunk_number) Number_of_Chunks from gsmadmin_internal.database a, gsmadmin_internal.chunk_loc b where a.database_num=b.database_num group by a.name;
    
    SHARD					 NUMBER_OF_CHUNKS
    ---------------------------------------- ----------------
    shd1_shdpdb1						6
    shd2_shdpdb2						6
    
    SQL> 
    ```

    

16. Connect into the app_schema/app_schema on the catadb, shard1, shard2 databases and verify that the sharded and duplicated tables are created.

    ```
    SQL> connect app_schema/app_schema@cata:1521/catapdb
    Connected.
    SQL> select table_name from user_tables;
    
    TABLE_NAME
    --------------------------------------------------------------------------------
    CUSTOMERS
    ORDERS
    LINEITEMS
    PRODUCTS
    MLOG$_PRODUCTS
    RUPD$_PRODUCTS
    
    6 rows selected.
    
    SQL> connect app_schema/app_schema@shd1:1521/shdpdb1
    Connected.
    SQL> select table_name from user_tables;
    
    TABLE_NAME
    --------------------------------------------------------------------------------
    CUSTOMERS
    ORDERS
    LINEITEMS
    PRODUCTS
    USLOG$_PRODUCTS
    
    SQL> connect app_schema/app_schema@shd2:1521/shdpdb2
    Connected.
    SQL> select table_name from user_tables;
    
    TABLE_NAME
    --------------------------------------------------------------------------------
    CUSTOMERS
    ORDERS
    LINEITEMS
    PRODUCTS
    USLOG$_PRODUCTS
    
    SQL> 
    ```

    

17. Exit the sqlplus.

    ```
    SQL> exit
    Disconnected from Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
    Version 19.7.0.0.0
    [oracle@cata ~]$
    ```




## **Step 3:** Migrate Data to the Sharded Tables

Duplicated tables reside in the shard catalog, they are always loaded into the shard catalog database using any of available data loading utilities, or plain SQL. 

For the sharded tables, you have two options. 

- Loaded using the sharding coordinator (catalog)
- Loaded directly into the shards, using the Data Pump utility.

Loading the data directly into the database shards is much faster, because each shard is loaded separately. The Data Pump Import detects that you are importing into a shard and only load rows that belong to that shard.  

In this lab, we will load the public table to the catalog database and load sharded tables directly into the shards.

1. Use SQLPLUS, connect to the catalog pdb with `app_schema` user.

   ```
   [oracle@cata ~]$ sqlplus app_schema/app_schema@cata:1521/catapdb
   
   SQL*Plus: Release 19.0.0.0.0 - Production on Sat Dec 5 03:21:31 2020
   Version 19.7.0.0.0
   
   Copyright (c) 1982, 2020, Oracle.  All rights reserved.
   
   
   Connected to:
   Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
   Version 19.7.0.0.0
   
   SQL> 
   ```
   
   
   
2. Create a data pump directory. Exit the SQLPLUS.

   ```
   SQL> alter session enable shard ddl;
   Session altered.
   
   SQL> create directory demo_pump_dir as '/home/oracle';
   
   Directory created.
   
   SQL> exit
   Disconnected from Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
   Version 19.7.0.0.0
   [oracle@cata ~]$ 
   ```

   

3. Connect to the catalog host, switch to oracle user.

   ```
   
   ```

   

4. Run the following command to import the public table data.

   ```
   
   ```

   

5. The result screen like the following.

   ```
   
   ```

   

6. Connect to the Shard1 host, switch to oracle user.

   ```
   $ ssh -i labkey opc@152.67.196.240
   Last login: Sat Dec  5 09:56:58 2020 from 59.66.120.23
   -bash: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8): No such file or directory
   [opc@shd1 ~]$ sudo su - oracle
   Last login: Sat Dec  5 09:57:04 GMT 2020 on pts/0
   [oracle@shd1 ~]$ 
   ```

   

7. Run the following command to import data into the shard1 tables.

   ```
   [oracle@shd1 ~]$ impdp app_schema/app_schema@shd1:1521/shdpdb1 directory=demo_pump_dir \
         dumpfile=original.dmp logfile=imp.log \
         table_exists_action=append \
         content=DATA_ONLY
   ```

   

8. The result likes the following.

   ```
   Import: Release 19.0.0.0.0 - Production on Sat Dec 5 11:16:18 2020
   Version 19.7.0.0.0
   
   Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.
   
   Connected to: Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
   Master table "APP_SCHEMA"."SYS_IMPORT_FULL_01" successfully loaded/unloaded
   Starting "APP_SCHEMA"."SYS_IMPORT_FULL_01":  app_schema/********@shd1:1521/shdpdb1 directory=demo_pump_dir dumpfile=original.dmp logfile=imp.log table_exists_action=append content=DATA_ONLY 
   Processing object type SCHEMA_EXPORT/TABLE/TABLE_DATA
   . . imported "APP_SCHEMA"."CUSTOMERS"                    3.313 MB    4922 out of 14707 rows
   . . imported "APP_SCHEMA"."PRODUCTS"                     27.26 KB     480 rows
   . . imported "APP_SCHEMA"."ORDERS"                       1.099 MB    7387 out of 22021 rows
   . . imported "APP_SCHEMA"."LINEITEMS"                    1.558 MB   13188 out of 39195 rows
   Job "APP_SCHEMA"."SYS_IMPORT_FULL_01" successfully completed at Sat Dec 5 11:17:04 2020 elapsed 0 00:00:46
   
   [oracle@shd1 ~]$
   ```

   

9. Connect to the Shard2 host, switch to oracle user.

   ```
   
   ```

   

10. Run the following command to load data into shard2 tables.

   ```
   [oracle@shd2 ~]$ impdp app_schema/app_schema@shd2:1521/shdpdb2 directory=demo_pump_dir \
          dumpfile=original.dmp logfile=imp.log \
          table_exists_action=append \
          content=DATA_ONLY
   ```

   

11. The result like the following.

    ```
    
    ```

    

## **Step 4:** Setup and Run the Demo Application

1. Login to the catalog host, switch to oracle user. 

   ```
   $ ssh -i labkey opc@152.67.196.50
   Last login: Mon Nov 30 03:06:29 2020 from 202.45.129.206
   -bash: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8): No such file or directory
   [opc@cata ~]$ sudo su - oracle
   Last login: Mon Nov 30 03:06:34 GMT 2020 on pts/0
   [oracle@cata ~]$
   ```

   

2. Change to the `sdb_demo_app/sql` directory.

   ```
   [oracle@cata ~]$ <copy>cd ~/sdb_demo_app/sql</copy>
   [oracle@cata sql]$
   ```

   

3. View the content of the `sdb_demo_app_ext.sql`. Make sure the connect string is correct.

   ```
   [oracle@cata sql]$ <copy>cat sdb_demo_app_ext.sql</copy> 
   -- Create catalog monitor packages
   connect / as sysdba
   alter session set container=catapdb;
   @catalog_monitor.sql
   
   connect app_schema/app_schema@cata:1521/catapdb;
   
   alter session enable shard ddl;
   
   CREATE OR REPLACE VIEW SAMPLE_ORDERS AS
     SELECT OrderId, CustId, OrderDate, SumTotal FROM
       (SELECT * FROM ORDERS ORDER BY OrderId DESC)
         WHERE ROWNUM < 10;
   
   alter session disable shard ddl;
   
   -- Allow a special query for dbaview
   connect / as sysdba
   alter session set container=catapdb;
   
   -- For demo app purposes
   grant shard_monitor_role, gsmadmin_role to app_schema;
   
   alter session enable shard ddl;
   
   create user dbmonuser identified by TEZiPP4MsLLL;
   grant connect, alter session, shard_monitor_role, gsmadmin_role to dbmonuser;
   
   grant all privileges on app_schema.products to dbmonuser;
   grant read on app_schema.sample_orders to dbmonuser;
   
   alter session disable shard ddl;
   -- End workaround
   
   exec dbms_global_views.create_any_view('SAMPLE_ORDERS', 'APP_SCHEMA.SAMPLE_ORDERS', 'GLOBAL_SAMPLE_ORDERS', 0, 1);
   [oracle@cata sql]$ 
   ```

   

4. Using SQLPLUS to run the script.

   ```
   [oracle@cata sql]$ sqlplus /nolog
   
   SQL*Plus: Release 19.0.0.0.0 - Production on Mon Nov 30 05:54:14 2020
   Version 19.7.0.0.0
   
   Copyright (c) 1982, 2020, Oracle.  All rights reserved.
   
   
   Connected to:
   Oracle Database 19c Enterprise Edition Release 19.0.0.0.0 - Production
   Version 19.7.0.0.0
   
   SQL> @sdb_demo_app_ext.sql
   ```

   

5. The result likes the following.

   ```
   Connected.
   
   Session altered.
   
   
   Session altered.
   
   
   Role created.
   
   
   Grant succeeded.
   
   
   Grant succeeded.
   
   
   Grant succeeded.
   
   
   Grant succeeded.
   
   
   Session altered.
   
   
   Package created.
   
   No errors.
   
   Package body created.
   
   No errors.
   
   PL/SQL procedure successfully completed.
   
   
   Type created.
   
   
   Type created.
   
   
   Package created.
   
   No errors.
   
   Package body created.
   
   No errors.
   
   Package body created.
   
   No errors.
   
   Grant succeeded.
   
   
   Grant succeeded.
   
   
   Grant succeeded.
   
   
   PL/SQL procedure successfully completed.
   
   
   PL/SQL procedure successfully completed.
   
   
   PL/SQL procedure successfully completed.
   
   
   PL/SQL procedure successfully completed.
   
   
   PL/SQL procedure successfully completed.
   
   Connected.
   
   Session altered.
   
   
   View created.
   
   
   Session altered.
   
   Connected.
   
   Session altered.
   
   
   Grant succeeded.
   
   
   Session altered.
   
   
   User created.
   
   
   Grant succeeded.
   
   
   Grant succeeded.
   
   
   Grant succeeded.
   
   
   Session altered.
   
   
   PL/SQL procedure successfully completed.
   
   SQL> 
   ```

   

6. Exit the sqlplus. Change directory to the `sdb_demo_app`.

   ```
   [oracle@cata ~]$ cd ~/sdb_demo_app
   [oracle@cata sdb_demo_app]$ 
   ```

   

7. Modify the `sdbdemo.properties` file like the following. Because we have no data guard standby database setup in this lab, we also use the `oltp_rw_srvc.orasdb.oradbcloud` for the readonly service.

   ```
   name=demo
   connect_string=(ADDRESS_LIST=(LOAD_BALANCE=off)(FAILOVER=on)(ADDRESS=(HOST=localhost)(PORT=1522)(PROTOCOL=tcp)))
   monitor.user=dbmonuser
   monitor.pass=TEZiPP4MsLLL
   #app.service.write=oltp_rw_srvc.cust_sdb.oradbcloud
   app.service.write=oltp_rw_srvc.orasdb.oradbcloud
   #app.service.readonly=oltp_ro_srvc.cust_sdb.oradbcloud
   app.service.readonly=oltp_rw_srvc.orasdb.oradbcloud
   app.user=app_schema
   app.pass=app_schema
   app.threads=7
   ```

   

8. Start the workload by executing command: `./run.sh demo sdbdemo.properties`.

   ```
   [oracle@cata sdb_demo_app]$ <copy>./run.sh demo sdbdemo.properties</copy>
   ```

   

9. The result likes the following.

   ```
   Performing initial fill of the products table...
   Syncing shards...
    RO Queries | RW Queries | RO Failed  | RW Failed  | APS 
             0            0            0            0            1
             0            0            0            0            0
            85            4            0            0           25
           639          109            0            0          191
          2508          451            0            0          636
          4731          783            0            0          746
          7212         1174            0            0          838
          9763         1543            0            0          871
         12269         1905            0            0          854
         14337         2265            0            0          701
         16250         2657            0            0          652
         18242         3020            0            0          674
         20548         3366            0            0          779
         22710         3697            0            0          742
         24959         4058            0            0          768
         26933         4405            1            0          675
         29219         4818            1            0          775
         31483         5202            1            0          758
         33654         5608            1            0          740
         36274         6092            1            0          891
    RO Queries | RW Queries | RO Failed  | RW Failed  | APS 
         38778         6546            1            0          845
         41267         6934            1            0          836
         43384         7299            1            0          727
         45840         7694            1            0          839
         48209         8066            1            0          820
         50467         8425            1            0          765
   ```

   

10. Open another terminal, connect to the catalog host, switch to oracle user. Change the directory to `sdb_demo_app`.

    ```
    $ ssh -i labkey opc@152.67.196.50
    Last login: Mon Nov 30 06:07:40 2020 from 202.45.129.206
    -bash: warning: setlocale: LC_CTYPE: cannot change locale (UTF-8): No such file or directory
    
    [opc@cata ~]$ sudo su - oracle
    Last login: Mon Nov 30 06:08:03 GMT 2020 on pts/0
    
    [oracle@cata ~]$ cd ~/sdb_demo_app
    [oracle@cata sdb_demo_app]$
    ```

    

11. Start the monitoring tool via the following command. Ignore the FileNotFoundException message.

    ```
     [oracle@cata sdb_demo_app]$ <copy>./run.sh monitor sdbdemo.properties</copy>
    @oracle.monitor.Main.registerDatabase : INFO 2020-11-30T06:17:33.417 : Context : /db/demo/info
    @oracle.monitor.DatabaseMonitor$BackgroundStatusCheck.run : java.lang.ArrayIndexOutOfBoundsException : 2
    @oracle.monitor.DatabaseMonitor$BackgroundStatusCheck.run : java.lang.ArrayIndexOutOfBoundsException : 3
    java.io.FileNotFoundException: /favicon.ico
    	at oracle.monitor.FileHandler.handle(FileHandler.java:129)
    	at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:79)
    	at sun.net.httpserver.AuthFilter.doFilter(AuthFilter.java:83)
    	at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:82)
    	at sun.net.httpserver.ServerImpl$Exchange$LinkHandler.handle(ServerImpl.java:675)
    	at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:79)
    	at sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:647)
    	at sun.net.httpserver.ServerImpl$DefaultExecutor.execute(ServerImpl.java:158)
    	at sun.net.httpserver.ServerImpl$Dispatcher.handle(ServerImpl.java:431)
    	at sun.net.httpserver.ServerImpl$Dispatcher.run(ServerImpl.java:396)
    	at java.lang.Thread.run(Thread.java:748)
    ```

    

12. From you laptop, launch a browser and use the URL: `http://xxx.xxx.xxx.xxx/8081`. Using the public ip address of the catalog host and the port number is 8081.

    ![image-20201130144513997](images/image-20201130144513997.png)

    

13. Scroll down the screen, you can see the Last inserted orders:

    ![image-20201130142515011](images/image-20201130142515011.png)

    

14. Press `Ctrl+C` to cancel the demo in both of the terminal.

     

15. sadf

    

You may proceed to the next lab.

